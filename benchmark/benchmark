#!/bin/sh
export LC_NUMERIC=C
export LC_COLLATE=C

tmp=/tmp
while [ -e $tmp ]; do
  tmp=/tmp/bis-$RANDOM
done
mkdir $tmp

if which bis >/dev/null 2>&1; then
  bis=`which bis`
else
  bis='../bis'
fi

srcdir=corpora/$1

files=`cd "$srcdir"; echo *`

# Table header
printf "<table>\n<thead>\n<tr>\n  <td></td>\n"
sed 's/^.*#//' <commands.txt | while read cmd; do
  printf "  <th colspan='2'><code>%s</code></th>\n" "$cmd"
done
printf "</tr>\n<tr>\n  <td></td>\n  "
while read cmd; do
  printf "<td>Ratio (%%)</td><td>Took (s)</td>" "$cmd"
done <commands.txt
printf "\n</tr>\n</thead>\n<tbody>\n"

# Testing
for f in $files; do
  printf "<tr>\n  <td>$f</td>\n  "
  sed 's/#.*$//' <commands.txt | while read cmd; do
    cp "$srcdir/$f" "$tmp/$f"
    file="$tmp/$f"
    time=`TIMEFORMAT='%R'; eval time $cmd "$tmp/$f" 2>&1 >/dev/null`
    rm -f "$tmp/$f"

    compressed=`stat -c %s $tmp/*`
    uncompressed=`stat -c %s $srcdir/$f`
    ratio=`echo $compressed/$uncompressed*100 | bc -l`
    printf "<td>%0.1f</td><td>%0.3f</td>" $ratio $time

    rm -f $tmp/*
  done
  printf "\n</tr>\n"
done
printf "</tbody>\n</table>\n"

rm -rf $tmp
